name: Test, Build Android & Deploy to Google Play

on:
  release:
    types: [published]

  workflow_dispatch:

concurrency:
  group: android-build
  cancel-in-progress: true

env:
  EXPO_PUBLIC_GEMINI_API_KEY: ${{ secrets.EXPO_PUBLIC_GEMINI_API_KEY }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test --if-present

  build-and-submit:
    if: false  # Disabled - remove this line to re-enable
    name: Build Android & Submit to Google Play
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set version and build number
        run: |
          # Get version from release tag (v1.0.0 -> 1.0.0), fallback to app.config.js
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION=$(node -p "require('./app.config.js').default.expo.version")
          fi

          # Use GitHub run number as build number (auto-increments: 1, 2, 3...)
          BUILD_NUMBER="${{ github.run_number }}"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

          # Update version in app.config.js
          node -e "
            const fs = require('fs');
            let content = fs.readFileSync('app.config.js', 'utf8');
            content = content.replace(/version: '[^']*'/, \"version: '$VERSION'\");
            fs.writeFileSync('app.config.js', content);
          "

      - name: Setup Firebase config
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          # Decode and create google-services.json for Firebase
          echo -n "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > google-services.json

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Generate native Android project
        run: npx expo prebuild --platform android --clean

      - name: Update Android version and build number
        run: |
          # Update build.gradle with version and build number
          BUILD_GRADLE="android/app/build.gradle"

          # Update versionCode
          sed -i "s/versionCode .*/versionCode $BUILD_NUMBER/" $BUILD_GRADLE

          # Update versionName
          sed -i "s/versionName .*/versionName \"$VERSION\"/" $BUILD_GRADLE

          echo "Set Android version to $VERSION ($BUILD_NUMBER)"

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo -n "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore

      - name: Build Android App Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew bundleRelease \
            -PMYAPP_RELEASE_STORE_FILE=release.keystore \
            -PMYAPP_RELEASE_KEY_ALIAS=$KEY_ALIAS \
            -PMYAPP_RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD \
            -PMYAPP_RELEASE_KEY_PASSWORD=$KEY_PASSWORD

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.aab
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Upload to Google Play (Internal Testing)
        if: false  # Disabled - remove this line to re-enable Google Play upload
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.forcetech.fridgescanner
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
